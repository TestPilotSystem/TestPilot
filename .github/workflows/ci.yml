name: CI Build, Lint, Test, and DB Check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: testpilotdb
          MYSQL_USER: user
          MYSQL_PASSWORD: password
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4 
        with:
          node-version: '20'
      - name: Verificar versi贸n de Node.js
        run: node -v
      
      # Prisma tiene una versi贸n 7 pero no es compatible
      - name: Generate Prisma Client
        run: npx prisma@6.19.0 generate

      - name: Run Lint (ESLint)
        run: npm run lint

      - name: Type Check and Build (TypeScript)
        run: npm run build

      - name: Set DATABASE_URL
        run: echo "DATABASE_URL=mysql://user:password@mysql:3306/testpilotdb" >> $GITHUB_ENV
        
      - name:  Validate and Apply Migrations (with Retries)
        run: |
          MAX_RETRIES=10
          RETRY_DELAY=5
          
          # Bucle de reintento para el comando de migraci贸n
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Running Prisma migrate deploy..."
            
            # Intentar la migraci贸n. Si es exitosa (c贸digo 0), salimos del bucle.
            if npx prisma migrate deploy; then
              echo "Prisma migration succeeded!"
              exit 0
            fi
            
            echo "Migration failed (P1001 expected). Waiting $RETRY_DELAY seconds before retry..."
            sleep $RETRY_DELAY
          done
          
          echo "Error: Database migration failed after $MAX_RETRIES retries."
          exit 1 # Falla el job si los 10 intentos fallan

      - name: Run Tests with Coverage
        run: npm run test:coverage