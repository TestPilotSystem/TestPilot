name: CI Build, Lint, Test, and DB Check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: testpilotdb
          MYSQL_USER: user
          MYSQL_PASSWORD: password
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Prisma tiene una versiÃ³n 7 pero no es compatible
      - name: Generate Prisma Client
        run: npx prisma@6.19.0 generate

      - name: Run Lint (ESLint)
        run: npm run lint

      - name: Type Check and Build (TypeScript)
        run: npm run build

      - name: Set DATABASE_URL
        run: echo "DATABASE_URL=mysql://user:password@mysql:3306/testpilotdb" >> $GITHUB_ENV

      - name: Wait for MySQL Service to be fully ready (Fixed Delay)
        run: sleep 30s
        
      - name: Validate Prisma Schema and Apply Migrations
        run: npx prisma migrate deploy

      - name: Run Tests with Coverage
        run: npm run test:coverage